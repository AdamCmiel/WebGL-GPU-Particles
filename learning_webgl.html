<html><head>
<title>2D ink droplet</title>

<script type="text/javascript">

var gl, 
    advecProgram, 
    forceProgram, 
    densityProgram, 
    divProgram, 
    renderProgram,
    frameBuffer1, 
    frameBuffer2, 
    texture1, 
    texture2,
    it = 3,
    n = 512;

var ext;

var shaders = {
  advec_frag: '',
  density_frag: '',
  div_frag: '',
  force_frag: '',
  render_frag: '',
  vertex: ''
};

function main() {

  loadShaders(function() {

    var canvas = document.getElementById("canvas");
    gl = canvas.getContext("webgl");
    ext = gl.getExtension("OES_texture_float");
    if (!gl || !ext) { alert("Error"); return; }

    //create programs
    forceProgram = createProgram(shaders.force_frag, shaders.vertex);
    densityProgram  = createProgram( shaders.density_frag, shaders.vertex );
    divProgram  = createProgram( shaders.div_frag, shaders.vertex );
    renderProgram  = createProgram( shaders.render_frag, shaders.vertex );
    advecProgram  = createProgram( shaders.advec_frag, shaders.vertex );

     //get uniforms
     forceProgram.forceLoc      = gl.getUniformLocation(forceProgram, "force");
     advecProgram.aPosLoc       = gl.getAttribLocation(advecProgram, "aPos");
     advecProgram.aTextCoordLoc = gl.getAttribLocation(advecProgram, "aTexCoord");
     divProgram.sampLoc     = gl.getUniformLocation(divProgram, "samp");
     advecProgram.sampLoc   = gl.getUniformLocation(advecProgram, "samp");
     densityProgram.sampLoc = gl.getUniformLocation(densityProgram, "samp");

     //enable vert arrays
     gl.enableVertexAttribArray( advecProgram.aPosLoc );
     gl.enableVertexAttribArray( advecProgram.aTextCoordLoc );

     //set the starting force
     gl.useProgram(forceProgram);
     gl.uniform1f(forceProgram.forceLoc, .001*.5*20 );
     
     gl.useProgram(divProgram);
     gl.uniform1i(divProgram.sampLoc, 1);

     
     gl.useProgram(advecProgram);
     
     var aPosData = new Float32Array([-1,-1,  1,-1,  -1,1, 1,1]);
     gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
     gl.bufferData(gl.ARRAY_BUFFER, aPosData, gl.STATIC_DRAW);
     gl.vertexAttribPointer(advecProgram.aPosLoc, 2, gl.FLOAT, gl.FALSE, 8, 0);

     var aTextureCoordData = new Float32Array([0,0, 1,0, 0,1, 1,1]);
     gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
     gl.bufferData(gl.ARRAY_BUFFER, aTextureCoordData, gl.STATIC_DRAW);

     gl.vertexAttribPointer(advecProgram.aTextCoordLoc, 2, gl.FLOAT, gl.FALSE, 8, 0);
     gl.uniform1i(advecProgram.sampLoc, 1);

     var pixels = [], h = 2/n, density;
     for(var i = 0; i<n; i++)
     for(var j = 0; j<n; j++){
       var x = h*(j-n/2),  y = h*(i-n/2);
       if (x*x + y*y > .02) density = 0; else density= 2;
       // pixels.push( 0, 0, density, 0 );
       pixels.push( 0, 0, 0, 0 );
     }

     texture1 = gl.createTexture();
     gl.activeTexture(gl.TEXTURE0);
     gl.bindTexture(gl.TEXTURE_2D, texture1);
     gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);
     gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, n, n, 0, gl.RGBA, gl.FLOAT, new Float32Array(pixels));
     gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
     gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

     texture2 = gl.createTexture();
     gl.activeTexture(gl.TEXTURE1);
     gl.bindTexture(gl.TEXTURE_2D, texture2);
     gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);
     gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, n, n, 0, gl.RGBA, gl.FLOAT, new Float32Array(pixels));
     gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
     gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

     frameBuffer1 = gl.createFramebuffer();
     gl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer1);
     gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture1, 0);
    
    if( gl.checkFramebufferStatus(gl.FRAMEBUFFER) != gl.FRAMEBUFFER_COMPLETE)
    alert(err + "FLOAT as the color attachment to an frameBuffer1");

     frameBuffer2 = gl.createFramebuffer();
     gl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer2);
     gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture2, 0);

     anim();
  });
}
function draw(){
  gl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer2);
  gl.useProgram(forceProgram);
  gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

  gl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer1);
  gl.useProgram(advecProgram);
  gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

  gl.useProgram(densityProgram);
  for(var i = 0; i < it; i++){
    gl.uniform1i(densityProgram.sampLoc, 0);
    gl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer2);
    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

    gl.uniform1i(densityProgram.sampLoc, 1);
    gl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer1);
    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
  }
  gl.uniform1i(densityProgram.sampLoc, 0);
  gl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer2);
  gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

  gl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffer1);
  gl.useProgram(divProgram);
  gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

  gl.useProgram(renderProgram);
  gl.bindFramebuffer(gl.FRAMEBUFFER, null);
  gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

}
function anim(){
   draw();
   requestAnimationFrame(anim);
}


function loadShaders( callback ) {
    var queue = 0;
    function loadHandler( name, req ) {
        return function() {
            shaders[ name ] = req.responseText;
            if ( --queue <= 0 ) callback();
        };
    }
    for ( var name in shaders ) {
        queue++;
        var req = new XMLHttpRequest();
        req.onload = loadHandler( name, req );
        req.open( 'get', 'ink_glsl/' + name + '.glsl', true );
        req.send();
    }
}

function createShader( source, type ) {
    var shader = gl.createShader( type );
    gl.shaderSource( shader, source );
    gl.compileShader( shader );
    if ( !gl.getShaderParameter( shader, gl.COMPILE_STATUS ) )
        throw gl.getShaderInfoLog( shader );
    return shader;
}

function createProgram(fragmentSource, vertexSource) {
    var vs = createShader( vertexSource, gl.VERTEX_SHADER );
    var fs = createShader( fragmentSource, gl.FRAGMENT_SHADER );
    var program = gl.createProgram();
    gl.attachShader( program, vs );
    gl.attachShader( program, fs );
    gl.linkProgram( program );
    if ( !gl.getProgramParameter( program, gl.LINK_STATUS ) )
        throw gl.getProgramInfoLog( program );
    return program;
}

window.addEventListener('mousemove', function(ev) {
  var x = ev.clientX, y = ev.clientY;
  gl.activeTexture(gl.TEXTURE0);
  gl.bindTexture( gl.TEXTURE_2D, texture1 );
  var data = [];
  for(var i=0; i<16; i++) {
    data.push(0, 0, 2, 0);  
  }
  
  if(512 - y < 0 || x < 0) return;
  gl.texSubImage2D(
            // target, detail level, x, y, width, height
            gl.TEXTURE_2D, 0, x , 512 - y, 4, 4,
            // data format, data type, pixels
            gl.RGBA, gl.FLOAT, new Float32Array( data )
        );
});

</script>
</head>
<body onload="main()">
  <canvas id="canvas" width="512" height="512"></canvas>
</body>
</html>
